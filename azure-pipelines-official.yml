trigger: none

pr: none

variables:
  ReleaseArguments: ' --filter "TestCategory!=Quarantine" --verbosity normal ' 
  VmImage: windows-latest # https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops 
  BuildConfiguration: Release
  Packaging.EnableSBOMSigning: true

stages:
# - stage:
#   displayName: Gate 
#   jobs:
#     - template:  templates/static-tools.yml
#       parameters:
#         BuildConfiguration: $(BuildConfiguration)
#         VmImage: $(VmImage)

#     - template:  templates/build-test.yml
#       parameters:
#         BuildConfiguration: $(BuildConfiguration)
#         Arguments: $(ReleaseArguments)
#         VmImage: $(VmImage)

- stage:
  displayName: Publish 
  jobs:
    - template:  templates/nuget-pack.yml
      parameters:
        BuildConfiguration: Release
        Arguments: $(ReleaseArguments)
        VmImage: $(VmImage)
        GenerateSymbols: true
        OutputPath: '$(Build.ArtifactStagingDirectory)/bin/AnyCPU/$(BuildConfiguration)/Microsoft.Azure.Cosmos'

    - job:
      dependsOn: GenerateNugetPackages
      pool:
        vmImage: $(VmImage)
    
      steps:
      - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
        inputs:
          BuildDropPath: '$(Build.ArtifactStagingDirectory)/bin/AnyCPU/$(BuildConfiguration)/Microsoft.Azure.Cosmos'

      - task: AzureFileCopy@2
        displayName: ' Copy Artifacts to Azure SDK Release blob storage'
        condition: and(succeeded(),ne(variables['BlobVersion'], ''))
        inputs:
          SourcePath: '$(Build.ArtifactStagingDirectory)/bin/AnyCPU/$(BuildConfiguration)/Microsoft.Azure.Cosmos'
          azureSubscription: azuresdkpartnerdrops
          Destination: AzureBlob
          storage: azuresdkpartnerdrops
          ContainerName: 'drops'
          BlobPrefix: 'cosmosdb/csharp/$(BlobVersion)'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifacts: Microsoft.Azure.Cosmos'
        inputs:
          artifactName: Microsoft.Azure.Cosmos

      - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
        displayName: 'Component Detection'
#
