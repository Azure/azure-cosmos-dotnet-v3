# Azure DevOps Pipeline for running integration tests against vNExt emulator
# This pipeline runs only the subset of emulator tests that pass with vNExt emulator
# vNExt emulator limitations:
#   - Gateway mode only (no Direct mode support)
#   - Single partition containers only (uses HTTP, not HTTPS)
#   - Limited feature set compared to legacy emulator
# 
# Test Results (as of 2025-12-19):
#   - 36 tests passing out of 225 tested (16% pass rate)
#   - Best categories: ClientTelemetryEmulator (38%), ChangeFeed (34%)
#   - See vnext-test-results.json for detailed breakdown
#
# Triggers:
#   - Daily scheduled run at 2 AM UTC
#   - On-demand via Azure Pipelines UI
#   - Via PR comment: /azp run vnext-emulator
# Does NOT block PRs - runs independently for validation only

name: vnext-emulator

trigger: none

pr: none

schedules:
- cron: "0 2 * * *"  # Run daily at 2 AM UTC
  displayName: Daily vNext Emulator Test Run
  branches:
    include:
    - master
  always: true  # Run even if there are no code changes

variables:
  VmImage: windows-latest
  BuildConfiguration: Release
  # vNext emulator requires HTTP endpoint and Gateway mode
  COSMOSDBEMULATOR_ENDPOINT: 'http://localhost:8081/'
  AZURE_COSMOS_EMULATOR_CONNECTION_MODE: 'Gateway'
  # Test filters - only run tests that pass with vNext emulator (36 passing tests)
  # Excludes MultiPartition and CrossPartition tests due to vNext single-partition limitation
  EmulatorPipeline1Arguments: ' --filter "(TestCategory=ClientTelemetryEmulator|TestCategory=Query|TestCategory=ReadFeed|TestCategory=Batch|TestCategory=ChangeFeed) & FullyQualifiedName!~MultiPartition & FullyQualifiedName!~CrossPartition" --verbosity normal '
  # Pipeline 2 disabled - all relevant tests covered in Pipeline 1
  EmulatorPipeline2Arguments: ''

jobs:
- job: VNextEmulatorTests_Pipeline1
  displayName: vNExt Emulator Tests - Client Telemetry, Query, ChangeFeed, ReadFeed, Batch (Gateway Mode)
  timeoutInMinutes: 90
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0
    inputs:
      packageType: 'runtime'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - template: templates/emulator-vnext-setup.yml

  - task: DotNetCoreCLI@2
    displayName: Microsoft.Azure.Cosmos.EmulatorTests (vNExt - Gateway Mode)
    condition: succeeded()
    retryCountOnTaskFailure: 2
    inputs:
      command: test
      projects: 'Microsoft.Azure.Cosmos/tests/Microsoft.Azure.Cosmos.EmulatorTests/*.csproj'
      arguments: $(EmulatorPipeline1Arguments) --configuration $(BuildConfiguration)
      nugetConfigPath: NuGet.config
      publishTestResults: true
      testRunTitle: Microsoft.Azure.Cosmos.EmulatorTests.vNext.Pipeline1
    env:
      AZURE_COSMOS_EMULATOR_CONNECTION_MODE: $(AZURE_COSMOS_EMULATOR_CONNECTION_MODE)
      AZURE_COSMOS_NON_STREAMING_ORDER_BY_FLAG_DISABLED: true

  - pwsh: |
      Write-Host "Stopping vNExt Emulator..." -ForegroundColor green
      docker stop cosmos-emulator-vnext
      docker rm cosmos-emulator-vnext
    displayName: Cleanup vNExt Emulator
    condition: always()

- job: VNextEmulatorTests_Pipeline2
  displayName: vNExt Emulator Tests - Others (Gateway Mode)
  timeoutInMinutes: 90
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0
    inputs:
      packageType: 'runtime'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - template: templates/emulator-vnext-setup.yml

  - task: DotNetCoreCLI@2
    displayName: Microsoft.Azure.Cosmos.EmulatorTests (vNExt - Gateway Mode)
    condition: succeeded()
    retryCountOnTaskFailure: 2
    inputs:
      command: test
      projects: 'Microsoft.Azure.Cosmos/tests/Microsoft.Azure.Cosmos.EmulatorTests/*.csproj'
      arguments: $(EmulatorPipeline2Arguments) --configuration $(BuildConfiguration)
      nugetConfigPath: NuGet.config
      publishTestResults: true
      testRunTitle: Microsoft.Azure.Cosmos.EmulatorTests.vNext.Pipeline2
    env:
      AZURE_COSMOS_EMULATOR_CONNECTION_MODE: $(AZURE_COSMOS_EMULATOR_CONNECTION_MODE)
      AZURE_COSMOS_NON_STREAMING_ORDER_BY_FLAG_DISABLED: true

  - pwsh: |
      Write-Host "Stopping vNExt Emulator..." -ForegroundColor green
      docker stop cosmos-emulator-vnext
      docker rm cosmos-emulator-vnext
    displayName: Cleanup vNExt Emulator
    condition: always()

- job: VNextEmulatorTests_Encryption
  displayName: vNExt Emulator Encryption Tests (Gateway Mode)
  timeoutInMinutes: 90
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0
    inputs:
      packageType: 'runtime'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - template: templates/emulator-vnext-setup.yml

  - task: DotNetCoreCLI@2
    displayName: Microsoft.Azure.Cosmos.Encryption.EmulatorTests (vNExt - Gateway Mode)
    condition: succeeded()
    retryCountOnTaskFailure: 2
    inputs:
      command: test
      projects: 'Microsoft.Azure.Cosmos.Encryption/tests/EmulatorTests/*.csproj'
      arguments: --filter "TestCategory!=Quarantine & TestCategory!=Ignore" --verbosity normal --configuration $(BuildConfiguration)
      nugetConfigPath: NuGet.config
      publishTestResults: true
      testRunTitle: Microsoft.Azure.Cosmos.Encryption.EmulatorTests.vNext
    env:
      AZURE_COSMOS_EMULATOR_CONNECTION_MODE: $(AZURE_COSMOS_EMULATOR_CONNECTION_MODE)
      AZURE_COSMOS_NON_STREAMING_ORDER_BY_FLAG_DISABLED: true

  - pwsh: |
      Write-Host "Stopping vNExt Emulator..." -ForegroundColor green
      docker stop cosmos-emulator-vnext
      docker rm cosmos-emulator-vnext
    displayName: Cleanup vNExt Emulator
    condition: always()

- job: VNextEmulatorTests_EncryptionCustom
  displayName: vNExt Emulator Encryption.Custom Tests (Gateway Mode)
  timeoutInMinutes: 90
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0
    inputs:
      packageType: 'runtime'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - template: templates/emulator-vnext-setup.yml

  - task: DotNetCoreCLI@2
    displayName: Microsoft.Azure.Cosmos.Encryption.Custom.EmulatorTests (vNExt - Gateway Mode)
    condition: succeeded()
    retryCountOnTaskFailure: 2
    inputs:
      command: test
      projects: 'Microsoft.Azure.Cosmos.Encryption.Custom/tests/EmulatorTests/*.csproj'
      arguments: --filter "TestCategory!=Quarantine & TestCategory!=Ignore" --verbosity normal --configuration $(BuildConfiguration)
      nugetConfigPath: NuGet.config
      publishTestResults: true
      testRunTitle: Microsoft.Azure.Cosmos.Encryption.Custom.EmulatorTests.vNext
    env:
      AZURE_COSMOS_EMULATOR_CONNECTION_MODE: $(AZURE_COSMOS_EMULATOR_CONNECTION_MODE)
      AZURE_COSMOS_NON_STREAMING_ORDER_BY_FLAG_DISABLED: true

  - pwsh: |
      Write-Host "Stopping vNExt Emulator..." -ForegroundColor green
      docker stop cosmos-emulator-vnext
      docker rm cosmos-emulator-vnext
    displayName: Cleanup vNExt Emulator
    condition: always()
