{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "Benchmarking-dotnet-SDK",
      "metadata": {
        "description": "Specifies a name for generating resource names."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the location for all resources."
      }
    },
    "metricsReportingIntervalInSec": {
      "type": "int",
      "defaultValue": 10
    },
    "applicationInsightsName": {
      "type": "string",
      "defaultValue": "CosmosDBBenchmarkApplicationInsights",
      "metadata": {
        "description": "Specifies Application Insights Account Name"
      }
    },
    "dashboardName": {
      "type": "string",
      "defaultValue": "Cosmos Benchmark Statistics",
      "metadata": {
        "description": "Specifies Application Insights Dashboard Name"
      }
    }
  },
  "variables": {
    "appInsightsResourceIds": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/microsoft.insights/components/', parameters('applicationInsightsName'))]",
    "chart0Expression": "[concat('customMetrics\n| where name == \"ReadOperationLatencyInMs\" and timestamp > ago(1d)\n| summarize\n    percentile(value, 50),\n    percentile(value, 75),\n    percentile(value, 90),\n    percentile(value, 95)\n    by ts = bin(timestamp, ', parameters('metricsReportingIntervalInSec'), 's)\n| render timechart \n\n')]",
    "chart1Expression": "[concat('customMetrics\n| where name == \"ReadOperationLatencyInMs\" and timestamp > ago(1d)\n| summarize\n    percentile(value, 99),\n    percentile(value, 99.9),\n    percentile(value, 99.99)\n    by ts = bin(timestamp, ', parameters('metricsReportingIntervalInSec'), 's)\n| render timechart \n\n')]",
    "chart2Expression": "[concat('customMetrics\n| where name == \"ReadOperationRps\" and timestamp > ago(1d)\n| summarize\n    by ts = bin(timestamp, ', parameters('metricsReportingIntervalInSec'), 's)\n| render timechart \n\n')]"
  },
  "resources": [
    {
      "name": "[parameters('applicationInsightsName')]",
      "type": "Microsoft.Insights/components",
      "apiVersion": "2015-05-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "ApplicationId": "[parameters('applicationInsightsName')]",
        "Application_Type": "web"
      }
    },
    {
      "name": "CosmosDBBenchmarkDashboard",
      "type": "Microsoft.Portal/dashboards",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-08-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
      ],
      "tags": {
        "hidden-title": "[parameters('dashboardName')]"
      },

      "properties": {
        "lenses": {
          "0": {
            "order": 0,
            "parts": {
              "0": {
                "position": {
                  "x": 0,
                  "y": 0,
                  "colSpan": 10,
                  "rowSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[variables('appInsightsResourceIds')]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "104528fc-0216-49c6-bf70-fffe9d37f93d",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "[variables('chart0Expression')]",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Latencies P50, P75, P90, P95 in Ms",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "CosmosDBBenchmarkTestAppInsights",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "ts",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "percentile_value_50",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_75",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_90",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_95",
                            "type": "real"
                          }
                        ],
                        "splitBy": [],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Dimensions": {
                        "xAxis": {
                          "name": "ts",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "percentile_value_50",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_75",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_90",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_95",
                            "type": "real"
                          }
                        ],
                        "splitBy": [],
                        "aggregation": "Sum"
                      },
                      "IsQueryContainTimeRange": true
                    }
                  },
                  "2": {
                    "position": {
                      "x": 0,
                      "y": 6,
                      "colSpan": 10,
                      "rowSpan": 6
                    },
                    "metadata": {
                      "inputs": [
                        {
                          "name": "resourceTypeMode",
                          "isOptional": true
                        },
                        {
                          "name": "ComponentId",
                          "isOptional": true
                        },
                        {
                          "name": "Scope",
                          "value": {
                            "resourceIds": [
                              "[variables('appInsightsResourceIds')]"
                            ]
                          },
                          "isOptional": true
                        },
                        {
                          "name": "PartId",
                          "value": "104528fc-0216-49c6-bf70-fffe9d37f93e",
                          "isOptional": true
                        },
                        {
                          "name": "Version",
                          "value": "2.0",
                          "isOptional": true
                        },
                        {
                          "name": "TimeRange",
                          "isOptional": true
                        },
                        {
                          "name": "DashboardId",
                          "isOptional": true
                        },
                        {
                          "name": "DraftRequestParameters",
                          "isOptional": true
                        },
                        {
                          "name": "Query",
                          "value": "customMetrics\n| where name == \"ReadOperationRps\" and timestamp > ago(1d)\n| summarize\n    percentile(value, 50),\n    percentile(value, 75),\n    percentile(value, 90),\n    percentile(value, 95)\n    by ts = bin(timestamp, 5s)\n| render timechart \n\n",
                          "isOptional": true
                        },
                        {
                          "name": "ControlType",
                          "value": "FrameControlChart",
                          "isOptional": true
                        },
                        {
                          "name": "SpecificChart",
                          "value": "Line",
                          "isOptional": true
                        },
                        {
                          "name": "PartTitle",
                          "value": "Analytics",
                          "isOptional": true
                        },
                        {
                          "name": "PartSubTitle",
                          "value": "CosmosDBBenchmarkTestAppInsights",
                          "isOptional": true
                        },
                        {
                          "name": "Dimensions",
                          "value": {
                            "xAxis": {
                              "name": "ts",
                              "type": "datetime"
                            },
                            "yAxis": [
                              {
                                "name": "percentile_value_95",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99_9",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99_99",
                                "type": "real"
                              }
                            ],
                            "splitBy": [],
                            "aggregation": "Sum"
                          },
                          "isOptional": true
                        },
                        {
                          "name": "LegendOptions",
                          "value": {
                            "isEnabled": true,
                            "position": "Bottom"
                          },
                          "isOptional": true
                        },
                        {
                          "name": "IsQueryContainTimeRange",
                          "value": true,
                          "isOptional": true
                        }
                      ],
                      "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                      "settings": {}
                    }
                  },
                  "3": {
                    "position": {
                      "x": 10,
                      "y": 6,
                      "colSpan": 10,
                      "rowSpan": 6
                    },
                    "metadata": {
                      "inputs": [
                        {
                          "name": "resourceTypeMode",
                          "isOptional": true
                        },
                        {
                          "name": "ComponentId",
                          "isOptional": true
                        },
                        {
                          "name": "Scope",
                          "value": {
                            "resourceIds": [
                              "[variables('appInsightsResourceIds')]"
                            ]
                          },
                          "isOptional": true
                        },
                        {
                          "name": "PartId",
                          "value": "104528fc-0216-49c6-bf70-fffe9d37f93e",
                          "isOptional": true
                        },
                        {
                          "name": "Version",
                          "value": "2.0",
                          "isOptional": true
                        },
                        {
                          "name": "TimeRange",
                          "isOptional": true
                        },
                        {
                          "name": "DashboardId",
                          "isOptional": true
                        },
                        {
                          "name": "DraftRequestParameters",
                          "isOptional": true
                        },
                        {
                          "name": "Query",
                          "value": "customMetrics\n| where name == \"ReadOperationRps\" and timestamp > ago(1d)\n| summarize\n    percentile(value, 95),\n    percentile(value, 99),\n    percentile(value, 99.9),\n    percentile(value, 99.99)\n    by ts = bin(timestamp, 5s)\n| render timechart \n\n",
                          "isOptional": true
                        },
                        {
                          "name": "ControlType",
                          "value": "FrameControlChart",
                          "isOptional": true
                        },
                        {
                          "name": "SpecificChart",
                          "value": "Line",
                          "isOptional": true
                        },
                        {
                          "name": "PartTitle",
                          "value": "Analytics",
                          "isOptional": true
                        },
                        {
                          "name": "PartSubTitle",
                          "value": "CosmosDBBenchmarkTestAppInsights",
                          "isOptional": true
                        },
                        {
                          "name": "Dimensions",
                          "value": {
                            "xAxis": {
                              "name": "ts",
                              "type": "datetime"
                            },
                            "yAxis": [
                              {
                                "name": "percentile_value_95",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99_9",
                                "type": "real"
                              },
                              {
                                "name": "percentile_value_99_99",
                                "type": "real"
                              }
                            ],
                            "splitBy": [],
                            "aggregation": "Sum"
                          },
                          "isOptional": true
                        },
                        {
                          "name": "LegendOptions",
                          "value": {
                            "isEnabled": true,
                            "position": "Bottom"
                          },
                          "isOptional": true
                        },
                        {
                          "name": "IsQueryContainTimeRange",
                          "value": true,
                          "isOptional": true
                        }
                      ],
                      "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                      "settings": {}
                    }
                  }
                }
              },
              "1": {
                "position": {
                  "x": 10,
                  "y": 0,
                  "colSpan": 10,
                  "rowSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[variables('appInsightsResourceIds')]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "104528fc-0216-49c6-bf70-fffe9d37f93e",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "[variables('chart1Expression')]",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Latencies P99, P99.9, P99.99 in Ms",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "CosmosDBBenchmarkTestAppInsights",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "ts",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "percentile_value_99",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_99_9",
                            "type": "real"
                          },
                          {
                            "name": "percentile_value_99_99",
                            "type": "real"
                          }
                        ],
                        "splitBy": [],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {}
                }
              },
              "2": {
                "position": {
                  "x": 10,
                  "y": 6,
                  "colSpan": 10,
                  "rowSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[variables('appInsightsResourceIds')]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "104528fc-0216-49c6-bf70-fffe9d37f93e",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "[variables('chart2Expression')]",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "RPs",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "CosmosDBBenchmarkTestAppInsights",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "ts",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "RPs",
                            "type": "real"
                          }
                        ],
                        "splitBy": [],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {}
                }
              }
            }
          }
        },
        "metadata": {
          "model": {
            "timeRange": {
              "value": {
                "relative": {
                  "duration": 24,
                  "timeUnit": 1
                }
              },
              "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
            },
            "filterLocale": {
              "value": "en-us"
            },
            "filters": {
              "value": {
                "MsPortalFx_TimeRange": {
                  "model": {
                    "format": "utc",
                    "granularity": "auto",
                    "relative": "24h"
                  },
                  "displayCache": {
                    "name": "UTC Time",
                    "value": "Past 24 hours"
                  },
                  "filteredPartIds": [
                    "StartboardPart-LogsDashboardPart-6d2eff36-636b-406d-8390-12e2135e700a",
                    "StartboardPart-LogsDashboardPart-6d2eff36-636b-406d-8390-12e2135e700c",
                    "StartboardPart-LogsDashboardPart-6d2eff36-636b-406d-8390-12e2135e700e"
                  ]
                }
              }
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "results": {
      "type": "string",
      "value": "The Benchmarking job has been triggered successfully. Please check the storage account you provided for Job Status and Results. The jobs status will be available in a storage table within a few minutes and results will be available once the job finishes."
    }
  }
}
