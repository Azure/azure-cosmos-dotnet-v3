# File: templates/build-thinclient.yml

parameters:
  BuildConfiguration: ''
  Arguments: ''
  VmImage: '' # https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops
  OS: 'Windows'
  EmulatorPipeline5Arguments: ' --filter "TestCategory=ThinClient" --verbosity normal '
  EmulatorPipeline5CategoryListName: ' ThinClient '
  ThinClientStrongConsistencyString: ''
  ThinClientConnectionString: ''
  MultiRegionConnectionString : ''
  IncludeEncryption: true
  IncludePerformance: true
  IncludeCoverage: true

jobs:
- job:
  displayName: EmulatorTests ${{ parameters.BuildConfiguration }} - ${{ parameters.EmulatorPipeline5CategoryListName }}
  timeoutInMinutes: 120
  condition: always()
  continueOnError: true
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0
    inputs:
      packageType: 'runtime'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - template: emulator-setup.yml

  - task: DotNetCoreCLI@2
    displayName: Microsoft.Azure.Cosmos.EmulatorTests - ${{ parameters.EmulatorPipeline5CategoryListName }}
    continueOnError: true
    inputs:
      command: test
      projects: 'Microsoft.Azure.Cosmos/tests/Microsoft.Azure.Cosmos.EmulatorTests/*.csproj'
      arguments: ${{ parameters.EmulatorPipeline5Arguments }} --configuration ${{ parameters.BuildConfiguration }} /p:OS=${{ parameters.OS }}
      nugetConfigPath: NuGet.config
      publishTestResults: true
      testRunTitle: Microsoft.Azure.Cosmos.EmulatorTests - ${{ parameters.EmulatorPipeline5CategoryListName }}
    env:
      COSMOSDB_THINCLIENT: ${{ parameters.ThinClientConnectionString }}
      COSMOSDB_THINCLIENTSTRONG: ${{ parameters.ThinClientStrongConsistencyString }}
      COSMOSDB_MULTI_REGION: ${{ parameters.MultiRegionConnectionString }}
      AZURE_COSMOS_THIN_CLIENT_ENABLED: 'True'
      AZURE_COSMOS_NON_STREAMING_ORDER_BY_FLAG_DISABLED: 'true'

- job: ThinClientBenchmarks
  displayName: ThinClient Benchmarks ${{ parameters.BuildConfiguration }}
  condition: always()
  continueOnError: true
  timeoutInMinutes: 120
  pool:
    name: 'OneES'

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Use .NET 6.0 SDK
    inputs:
      packageType: 'sdk'
      version: '6.x'

  - task: UseDotNet@2
    displayName: Use .NET 8.0 SDK
    inputs:
      packageType: 'sdk'
      version: '8.x'

  - task: DotNetCoreCLI@2
    displayName: Build perf tests
    inputs:
      command: build
      projects: 'Microsoft.Azure.Cosmos/tests/Microsoft.Azure.Cosmos.Performance.Tests/*.csproj'
      arguments: -c ${{ parameters.BuildConfiguration }}

  - task: DotNetCoreCLI@2
    displayName: Run ThinClientIntegrationBenchmark
    inputs:
      command: run
      projects: 'Microsoft.Azure.Cosmos/tests/Microsoft.Azure.Cosmos.Performance.Tests/*.csproj'
      arguments: >
        --configuration ${{ parameters.BuildConfiguration }}
        --no-restore --framework net6.0
        --allCategories=ThinClientIntegrationBenchmark
        -- -j Short -m
    env:
      COSMOSDB_THINCLIENT: ${{ parameters.ThinClientConnectionString }}
      AZURE_COSMOS_THIN_CLIENT_ENABLED: 'True'
